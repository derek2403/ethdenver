openapi: 3.0.0
info:
  title: Backend API
  description: API to manage Invoices, Privacy Views, and Tenant Registrations
  version: 2.0.0

tags:
  - name: Feature Flags
  - name: Auth
  - name: Admin
  - name: Invoices
  - name: Invoice Payment Requests
  - name: Logistics Views
  - name: Bookkeeper Views

paths:
  /feature-flags:
    get:
      tags: [Feature Flags]
      summary: Get feature flags
      operationId: getFeatureFlags
      responses:
        '200':
          description: A list of feature flags
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeatureFlags'
        '500':
          $ref: '#/components/responses/InternalError'
  /login-links:
    get:
      tags: [Auth]
      summary: Get list of links that initiate login
      operationId: listLinks
      responses:
        '200':
          description: Links that initiate login flows
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/LoginLink'
        '500':
          $ref: '#/components/responses/InternalError'

  /user:
    get:
      tags: [Auth]
      summary: Get Authenticated User
      operationId: getAuthenticatedUser
      responses:
        '200':
          description: Current authenticated user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthenticatedUser'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /admin/tenant-registrations:
    get:
      tags: [Admin]
      summary: List all Tenant Registrations
      operationId: listTenantRegistrations
      responses:
        '200':
          description: A list of Tenant Registrations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TenantRegistration'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags: [Admin]
      summary: Create Tenant Registration
      operationId: createTenantRegistration
      requestBody:
        description: Tenant Registration object
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TenantRegistrationRequest'
            examples:
              oauth2:
                value:
                  tenantId: "tenant-123"
                  partyId: "party-abc"
                  walletUrl: "http://wallet.localhost:2000/"
                  clientId: "client-xyz"
                  issuerUrl: "http://keycloak.localhost:8082/realms/AppProvider"
                  internal: false
              sharedSecret:
                value:
                  tenantId: "tenant-ss"
                  partyId: "party-ss"
                  walletUrl: "http://wallet.localhost:2000/"
                  users: [ "alice","bob" ]
                  internal: true
      responses:
        '201':
          description: Registration created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TenantRegistration'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalError'

  /admin/tenant-registrations/{tenantId}:
    delete:
      tags: [Admin]
      summary: Delete Tenant Registration
      operationId: deleteTenantRegistration
      parameters:
        - $ref: '#/components/parameters/TenantId'
      responses:
        '204':
          description: Tenant registration deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  # ── Invoices ──────────────────────────────────────────────────────

  /invoices:
    get:
      tags: [Invoices]
      summary: List all Invoices (including payment requests)
      operationId: listInvoices
      responses:
        '200':
          description: A list of Invoices
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/InvoiceResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'
    post:
      tags: [Invoices]
      summary: Create a new Invoice
      operationId: createInvoice
      parameters:
        - $ref: '#/components/parameters/CommandId'
      requestBody:
        description: Invoice creation parameters
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateInvoiceRequest'
      responses:
        '201':
          description: Invoice created
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

  /invoices/{contractId}:request-payment:
    post:
      tags: [Invoices]
      summary: Request payment for an Invoice
      operationId: requestInvoicePayment
      parameters:
        - $ref: '#/components/parameters/ContractId'
        - $ref: '#/components/parameters/CommandId'
      requestBody:
        description: Payment request parameters
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RequestPaymentRequest'
      responses:
        '201':
          description: Payment request created
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /invoices/{contractId}:complete-payment:
    post:
      tags: [Invoices]
      summary: Complete an Invoice payment
      operationId: completeInvoicePayment
      parameters:
        - $ref: '#/components/parameters/ContractId'
        - $ref: '#/components/parameters/CommandId'
      requestBody:
        description: Complete payment parameters
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompletePaymentRequest'
      responses:
        '200':
          description: Invoice payment completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoicePaymentResult'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /invoices/{contractId}:cancel:
    post:
      tags: [Invoices]
      summary: Cancel an open Invoice
      operationId: cancelInvoice
      parameters:
        - $ref: '#/components/parameters/ContractId'
        - $ref: '#/components/parameters/CommandId'
      requestBody:
        description: Cancellation parameters
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CancelRequest'
      responses:
        '204':
          description: Invoice cancelled
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /invoices/{contractId}:mark-paid:
    post:
      tags: [Invoices]
      summary: Mark an invoice as paid (demo shortcut, no wallet needed)
      operationId: markInvoicePaid
      parameters:
        - $ref: '#/components/parameters/ContractId'
        - $ref: '#/components/parameters/CommandId'
      responses:
        '204':
          description: Invoice marked as paid
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /invoices/{contractId}:share-with-carrier:
    post:
      tags: [Invoices]
      summary: Share logistics view of an invoice with a carrier
      operationId: shareWithCarrier
      parameters:
        - $ref: '#/components/parameters/ContractId'
        - $ref: '#/components/parameters/CommandId'
      requestBody:
        description: Carrier to share with
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShareWithCarrierRequest'
      responses:
        '201':
          description: LogisticsView created
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /invoices/{contractId}:share-with-bookkeeper:
    post:
      tags: [Invoices]
      summary: Share financial summary of an invoice with a bookkeeper
      operationId: shareWithBookkeeper
      parameters:
        - $ref: '#/components/parameters/ContractId'
        - $ref: '#/components/parameters/CommandId'
      requestBody:
        description: Bookkeeper to share with
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShareWithBookkeeperRequest'
      responses:
        '201':
          description: BookkeeperView created
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /invoice-payment-requests/{contractId}:withdraw:
    post:
      tags: [Invoice Payment Requests]
      summary: Withdraw an InvoicePaymentRequest
      operationId: withdrawInvoicePaymentRequest
      parameters:
        - $ref: '#/components/parameters/ContractId'
        - $ref: '#/components/parameters/CommandId'
      responses:
        '204':
          description: InvoicePaymentRequest withdrawn
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  # ── Logistics Views (Carrier) ────────────────────────────────────

  /logistics-views:
    get:
      tags: [Logistics Views]
      summary: List all LogisticsViews visible to the authenticated party
      operationId: listLogisticsViews
      responses:
        '200':
          description: A list of LogisticsViews
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/LogisticsViewResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /logistics-views/{contractId}:acknowledge:
    post:
      tags: [Logistics Views]
      summary: Acknowledge a LogisticsView
      operationId: acknowledgeLogisticsView
      parameters:
        - $ref: '#/components/parameters/ContractId'
        - $ref: '#/components/parameters/CommandId'
      responses:
        '204':
          description: LogisticsView acknowledged
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /logistics-views/{contractId}:revoke:
    post:
      tags: [Logistics Views]
      summary: Revoke a LogisticsView
      operationId: revokeLogisticsView
      parameters:
        - $ref: '#/components/parameters/ContractId'
        - $ref: '#/components/parameters/CommandId'
      responses:
        '204':
          description: LogisticsView revoked
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  # ── Bookkeeper Views ─────────────────────────────────────────────

  /bookkeeper-views:
    get:
      tags: [Bookkeeper Views]
      summary: List all BookkeeperViews visible to the authenticated party
      operationId: listBookkeeperViews
      responses:
        '200':
          description: A list of BookkeeperViews
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BookkeeperViewResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /bookkeeper-views/{contractId}:acknowledge:
    post:
      tags: [Bookkeeper Views]
      summary: Acknowledge a BookkeeperView
      operationId: acknowledgeBookkeeperView
      parameters:
        - $ref: '#/components/parameters/ContractId'
        - $ref: '#/components/parameters/CommandId'
      responses:
        '204':
          description: BookkeeperView acknowledged
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /bookkeeper-views/{contractId}:revoke:
    post:
      tags: [Bookkeeper Views]
      summary: Revoke a BookkeeperView
      operationId: revokeBookkeeperView
      parameters:
        - $ref: '#/components/parameters/ContractId'
        - $ref: '#/components/parameters/CommandId'
      responses:
        '204':
          description: BookkeeperView revoked
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  parameters:
    ContractId:
      name: contractId
      in: path
      required: true
      description: Ledger contract ID
      schema:
        type: string
    CommandId:
      name: commandId
      in: query
      required: true
      description: The command ID for the ledger transaction
      schema:
        type: string
    TenantId:
      name: tenantId
      in: path
      required: true
      description: Tenant identifier
      schema:
        type: string
  responses:
    BadRequest:
      description: Invalid request
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Unauthorized:
      description: Not authenticated
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Forbidden:
      description: Forbidden
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Resource not found
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Conflict:
      description: Conflict with current state of the resource
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    InternalError:
      description: An internal server error occurred
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
  schemas:
    TenantRegistrationRequest:
      type: object
      required:
        - tenantId
        - partyId
        - walletUrl
      properties:
        tenantId:
          type: string
        partyId:
          type: string
        walletUrl:
          type: string
        clientId:
          type: string
          description: Required when authMode is oauth2
        issuerUrl:
          type: string
          description: Required when authMode is oauth2
        users:
          type: array
          description: Required (non-empty) when authMode is shared-secret
          items:
            type: string

    TenantRegistration:
      type: object
      required:
        - tenantId
        - partyId
        - walletUrl
        - internal
      properties:
        tenantId:
          type: string
          description: Tenant identifier
        partyId:
          type: string
          description: Party identifier
        walletUrl:
          type: string
          description: Wallet URL for payment redirects
          format: uri
        clientId:
          type: string
          description: OAuth2 client identifier
        issuerUrl:
          type: string
          description: Issuer URL
          format: uri
        internal:
          type: boolean
          description: Internal registration
        users:
          type: array
          items:
            type: string
    AuthenticatedUser:
      type: object
      required:
        - name
        - party
        - roles
        - isAdmin
        - walletUrl
      properties:
        name:
          type: string
        party:
          type: string
        roles:
          type: array
          items:
            type: string
        isAdmin:
          type: boolean
        walletUrl:
          type: string

    LoginLink:
      type: object
      required:
        - name
        - url
      properties:
        name:
          type: string
        url:
          type: string

    Metadata:
      type: object
      properties:
        data:
          type: object
          additionalProperties:
            type: string

    FeatureFlags:
      type: object
      properties:
        authMode:
          type: string
          enum:
            - oauth2
            - shared-secret

    ErrorResponse:
      type: object
      properties:
        message:
          type: string
          nullable: true
          example: "TenantId is required"

    # ── Invoice Schemas ──────────────────────────────────────────────

    CreateInvoiceRequest:
      type: object
      required:
        - seller
        - buyer
        - sellerInfo
        - buyerInfo
        - shippingAddress
        - lineItems
        - currency
        - dueDate
        - description
      properties:
        seller:
          type: string
          description: Party ID of the seller
        buyer:
          type: string
          description: Party ID of the buyer
        sellerInfo:
          $ref: '#/components/schemas/PartyInfoRequest'
        buyerInfo:
          $ref: '#/components/schemas/PartyInfoRequest'
        shippingAddress:
          $ref: '#/components/schemas/AddressRequest'
        lineItems:
          type: array
          items:
            $ref: '#/components/schemas/LineItemRequest'
        currency:
          type: string
          description: "Currency code (e.g. 'CC' for Canton Coin)"
        dueDate:
          type: string
          format: date-time
          description: When payment is due
        paymentTerms:
          type: string
          description: "Payment terms (e.g. 'Net 30')"
        poNumber:
          type: string
          description: Purchase order number
        salesOrderNumber:
          type: string
          description: Sales order number
        notes:
          type: string
          description: Free-text notes
        deliveryTerms:
          type: string
          description: Delivery/shipping terms
        description:
          type: string
          description: Human-readable description (used in payment metadata)

    PartyInfoRequest:
      type: object
      required:
        - partyName
      properties:
        partyName:
          type: string
        regNumber:
          type: string
        taxNumber:
          type: string
        address:
          $ref: '#/components/schemas/AddressRequest'
        contact:
          $ref: '#/components/schemas/ContactRequest'

    AddressRequest:
      type: object
      properties:
        street:
          type: string
        city:
          type: string
        state:
          type: string
        postalCode:
          type: string
        country:
          type: string

    ContactRequest:
      type: object
      properties:
        name:
          type: string
        email:
          type: string
        phone:
          type: string

    LineItemRequest:
      type: object
      required:
        - itemName
        - quantity
        - unitPrice
      properties:
        itemName:
          type: string
        sku:
          type: string
        quantity:
          type: number
        unitOfMeasure:
          type: string
        unitPrice:
          type: number
        discount:
          type: number
          description: Discount amount per unit
        taxRate:
          type: number
          description: Tax rate as decimal (e.g. 0.1 for 10%)
        batchInfo:
          type: string
        deliveryDate:
          type: string

    InvoiceResponse:
      type: object
      required:
        - contractId
        - seller
        - buyer
        - provider
        - invoiceNum
        - invoiceDate
        - dueDate
        - currency
        - status
        - subtotal
        - totalDiscount
        - totalTax
        - grandTotal
        - amountPaid
        - balanceDue
        - description
      properties:
        contractId:
          type: string
        seller:
          type: string
        buyer:
          type: string
        provider:
          type: string
        invoiceNum:
          type: integer
        invoiceDate:
          type: string
          format: date-time
        dueDate:
          type: string
          format: date-time
        currency:
          type: string
        status:
          type: string
          enum: [Issued, PartiallyPaid, Paid, Void]
        sellerInfo:
          $ref: '#/components/schemas/PartyInfoResponse'
        buyerInfo:
          $ref: '#/components/schemas/PartyInfoResponse'
        shippingAddress:
          $ref: '#/components/schemas/AddressResponse'
        lineItems:
          type: array
          items:
            $ref: '#/components/schemas/LineItemResponse'
        taxBreakdown:
          type: array
          items:
            $ref: '#/components/schemas/TaxEntryResponse'
        subtotal:
          type: number
        totalDiscount:
          type: number
        totalTax:
          type: number
        grandTotal:
          type: number
        amountPaid:
          type: number
        balanceDue:
          type: number
        paymentTerms:
          type: string
        poNumber:
          type: string
        salesOrderNumber:
          type: string
        notes:
          type: string
        deliveryTerms:
          type: string
        description:
          type: string
        paymentRequests:
          type: array
          items:
            $ref: '#/components/schemas/InvoicePaymentRequestResponse'

    PartyInfoResponse:
      type: object
      properties:
        partyName:
          type: string
        regNumber:
          type: string
        taxNumber:
          type: string
        address:
          $ref: '#/components/schemas/AddressResponse'
        contact:
          $ref: '#/components/schemas/ContactResponse'

    AddressResponse:
      type: object
      properties:
        street:
          type: string
        city:
          type: string
        state:
          type: string
        postalCode:
          type: string
        country:
          type: string

    ContactResponse:
      type: object
      properties:
        name:
          type: string
        email:
          type: string
        phone:
          type: string

    LineItemResponse:
      type: object
      properties:
        itemName:
          type: string
        sku:
          type: string
        quantity:
          type: number
        unitOfMeasure:
          type: string
        unitPrice:
          type: number
        discount:
          type: number
        taxRate:
          type: number
        lineSubtotal:
          type: number
        batchInfo:
          type: string
        deliveryDate:
          type: string

    TaxEntryResponse:
      type: object
      properties:
        taxName:
          type: string
        taxRate:
          type: number
        taxAmount:
          type: number

    InvoicePaymentRequestResponse:
      type: object
      required:
        - contractId
        - seller
        - buyer
        - provider
        - invoiceNum
        - amount
        - description
        - requestId
        - prepareUntil
        - settleBefore
        - requestedAt
        - prepareDeadlinePassed
        - settleDeadlinePassed
      properties:
        contractId:
          type: string
        seller:
          type: string
        buyer:
          type: string
        provider:
          type: string
        invoiceNum:
          type: integer
        amount:
          type: number
        description:
          type: string
        requestId:
          type: string
        prepareUntil:
          type: string
          format: date-time
        settleBefore:
          type: string
          format: date-time
        requestedAt:
          type: string
          format: date-time
        allocationCid:
          type: string
        prepareDeadlinePassed:
          type: boolean
        settleDeadlinePassed:
          type: boolean

    RequestPaymentRequest:
      type: object
      required:
        - prepareUntilDuration
        - settleBeforeDuration
      properties:
        prepareUntilDuration:
          type: string
          description: "ISO-8601 duration for allocation deadline (e.g. 'PT1H')."
        settleBeforeDuration:
          type: string
          description: "ISO-8601 duration for settlement deadline (e.g. 'PT2H')."

    CompletePaymentRequest:
      type: object
      required:
        - paymentRequestContractId
        - allocationContractId
      properties:
        paymentRequestContractId:
          type: string
          description: The contract ID of the payment request
        allocationContractId:
          type: string
          description: The contract ID of the accepted allocation

    InvoicePaymentResult:
      type: object
      properties:
        invoiceId:
          type: string
        receiptId:
          type: string

    CancelRequest:
      type: object
      required:
        - meta
      properties:
        meta:
          $ref: '#/components/schemas/Metadata'

    ShareWithCarrierRequest:
      type: object
      required:
        - carrier
      properties:
        carrier:
          type: string
          description: Party ID of the carrier

    ShareWithBookkeeperRequest:
      type: object
      required:
        - bookkeeper
      properties:
        bookkeeper:
          type: string
          description: Party ID of the bookkeeper

    # ── Logistics View Schemas ──────────────────────────────────────

    LogisticsViewResponse:
      type: object
      required:
        - contractId
        - grantor
        - carrier
        - provider
        - invoiceRef
      properties:
        contractId:
          type: string
        grantor:
          type: string
        carrier:
          type: string
        provider:
          type: string
        invoiceRef:
          type: string
        orderRef:
          type: string
        shipFromAddress:
          $ref: '#/components/schemas/AddressResponse'
        shipToAddress:
          $ref: '#/components/schemas/AddressResponse'
        sellerContact:
          $ref: '#/components/schemas/ContactResponse'
        buyerContact:
          $ref: '#/components/schemas/ContactResponse'
        items:
          type: array
          items:
            $ref: '#/components/schemas/LogisticsItemResponse'
        deliveryTerms:
          type: string
        notes:
          type: string

    LogisticsItemResponse:
      type: object
      properties:
        itemName:
          type: string
        sku:
          type: string
        quantity:
          type: number
        unitOfMeasure:
          type: string
        batchInfo:
          type: string
        deliveryDate:
          type: string

    # ── Bookkeeper View Schemas ─────────────────────────────────────

    BookkeeperViewResponse:
      type: object
      required:
        - contractId
        - grantor
        - bookkeeper
        - provider
        - invoiceNum
        - status
        - grandTotal
      properties:
        contractId:
          type: string
        grantor:
          type: string
        bookkeeper:
          type: string
        provider:
          type: string
        invoiceNum:
          type: integer
        invoiceDate:
          type: string
          format: date-time
        sellerName:
          type: string
        buyerName:
          type: string
        currency:
          type: string
        status:
          type: string
          enum: [Issued, PartiallyPaid, Paid, Void]
        subtotal:
          type: number
        totalDiscount:
          type: number
        taxBreakdown:
          type: array
          items:
            $ref: '#/components/schemas/TaxEntryResponse'
        grandTotal:
          type: number
        amountPaid:
          type: number
        balanceDue:
          type: number
        itemCategories:
          type: array
          items:
            type: string
